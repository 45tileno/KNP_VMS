<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSense AI: Smart Farm Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        /* Custom Tailwind Configuration for font and animations */
        @layer base {
            body {
                font-family: 'Inter', sans-serif;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 font-inter">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-green-700 to-emerald-600 p-4 shadow-md flex justify-between items-center rounded-b-lg">
        <h1 class="text-white text-2xl md:text-3xl font-bold">AgroSense AI</h1>
        <nav>
            <div id="auth-status" class="flex items-center space-x-4">
                <!-- User name and location will be injected here by JS -->
                <span id="welcome-message" class="text-white text-sm md:text-base hidden sm:inline"></span>
                <!-- User ID will be injected here by JS -->
                <span id="user-id-display" class="text-white text-xs md:text-sm bg-green-800 px-2 py-1 rounded-full opacity-80 hidden"></span>
                <button id="logout-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="p-4 md:p-8">
        <!-- Loading Screen -->
        <section id="loading-screen" class="flex items-center justify-center min-h-screen bg-gray-100">
            <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
            <p id="loading-message" class="text-xl font-semibold text-gray-700 ml-4">Loading AgroSense AI...</p>
            <div id="loading-error-detail" class="mt-4 bg-red-100 text-red-700 p-4 rounded-md text-sm whitespace-pre-wrap hidden"></div>
        </section>

        <!-- Authentication Page (Login/Sign Up) -->
        <section id="auth-page" class="hidden flex justify-center items-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200">
                <h2 id="auth-title" class="text-3xl font-bold text-center text-gray-800 mb-6">Login to AgroSense AI</h2>
                <div id="auth-error-message" class="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm hidden"></div>
                <div id="auth-success-message" class="bg-green-100 text-green-700 p-3 rounded-md mb-4 text-sm hidden"></div>
                <form id="auth-form" class="space-y-5">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="auth-email">Email Address:</label>
                        <input type="email" id="auth-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-200" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="auth-password">Password:</label>
                        <input type="password" id="auth-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-200" required>
                    </div>
                    <button type="submit" id="auth-submit-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Login</button>
                </form>
                <p class="mt-6 text-center text-gray-600 text-sm">
                    Don't have an account? <button id="toggle-auth-mode" class="text-emerald-600 hover:text-emerald-800 font-semibold transition duration-200">Sign Up</button>
                </p>
            </div>
        </section>

        <!-- Profile Setup Page -->
        <section id="profile-setup-page" class="hidden flex justify-center items-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Set Up Your Farm Profile</h2>
                <div id="profile-error-message" class="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm hidden"></div>
                <div id="profile-success-message" class="bg-green-100 text-green-700 p-3 rounded-md mb-4 text-sm hidden"></div>
                <form id="profile-form" class="space-y-5">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="profile-name">Your Name:</label>
                        <input type="text" id="profile-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="farm-location">Farm Location (e.g., Kisii, Kenya):</label>
                        <input type="text" id="farm-location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" required>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Create Profile</button>
                </form>
            </div>
        </section>

        <!-- Farmer Dashboard -->
        <section id="farmer-dashboard" class="hidden container mx-auto p-4 md:p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Farm Dashboard</h2>
            <p class="text-gray-600 mb-6">
                <span class="font-semibold text-green-700">User ID:</span> <span id="dashboard-user-id">N/A</span>
            </p>

            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="tab-get-recommendations" class="px-6 py-3 text-lg font-semibold transition-colors duration-300 ease-in-out text-emerald-600 border-b-2 border-emerald-600">
                    Get New Recommendations
                </button>
                <button id="tab-recommendation-history" class="ml-4 px-6 py-3 text-lg font-semibold transition-colors duration-300 ease-in-out text-gray-600 hover:text-gray-800">
                    My Recommendation History
                </button>
            </div>

            <!-- Tab Content: Get New Recommendations -->
            <div id="tab-content-get-recommendations">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Simulated Data Input Form -->
                    <div class="bg-emerald-50 p-6 rounded-lg shadow-md border border-emerald-200">
                        <h3 class="text-2xl font-bold text-emerald-800 mb-4">Simulate Farm Conditions</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="crop-type">Crop Type:</label>
                                <select id="crop-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                    <option>Maize</option>
                                    <option>Wheat</option>
                                    <option>Beans</option>
                                    <option>Potatoes</option>
                                    <option>Sorghum</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="soil-moisture">Soil Moisture:</label>
                                <select id="soil-moisture" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                    <option>Very Dry</option>
                                    <option>Dry</option>
                                    <option>Moderate</option>
                                    <option>Wet</d>
                                    <option>Saturated</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="temperature">Temperature (Â°C):</label>
                                <input type="number" id="temperature" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="25" min="0" max="50" step="1">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="humidity">Humidity (%):</label>
                                <input type="number" id="humidity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="60" min="0" max="100" step="1">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="weather-forecast">Weather Forecast (Next 7 Days):</label>
                                <select id="weather-forecast" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                    <option>Sunny with no rain</option>
                                    <option>Partly Cloudy, chances of light rain</option>
                                    <option>Rainy, heavy downpours expected</option>
                                    <option>Cloudy, cool temperatures</option>
                                    <option>Drought conditions, no rain expected</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="pest-disease">Pest/Disease Presence:</label>
                                <select id="pest-disease" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                    <option>No</option>
                                    <option>Low Risk</option>
                                    <option>Moderate Risk</option>
                                    <option>High Risk</option>
                                    <option>Confirmed Infestation</option>
                                </select>
                            </div>
                            <button id="generate-recommendations-button" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Generate Recommendations</button>
                        </div>
                    </div>

                    <!-- AI Generated Recommendations Display -->
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">AgroSense AI Recommendations</h3>
                        <div id="ai-loading-spinner" class="flex items-center justify-center p-8 hidden">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
                            <p class="ml-4 text-gray-600">Analyzing data and generating insights...</p>
                        </div>
                        <div id="ai-error-display" class="bg-red-100 text-red-700 p-4 rounded-md text-sm whitespace-pre-wrap hidden"></div>
                        <div id="ai-response-display" class="bg-emerald-50 p-4 rounded-md text-gray-800 text-base whitespace-pre-wrap border border-emerald-200 max-h-96 overflow-y-auto hidden"></div>
                        <p id="ai-placeholder-message" class="text-gray-600 text-center py-8">
                            Enter farm conditions on the left and click "Generate Recommendations" to get AI-powered insights.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Recommendation History -->
            <div id="tab-content-recommendation-history" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">My Past Recommendations</h3>
                    <div id="recommendation-history-list" class="space-y-6">
                        <p class="text-gray-600 text-center py-8">Loading past recommendations...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Custom Alert Modal (instead of window.alert) -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm animate-fade-in-up">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Alert</h3>
            <p id="custom-alert-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="custom-alert-close" class="px-5 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-md transition duration-300 ease-in-out">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase SDKs from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase and App State Variables
        let db;
        let auth;
        let currentUser = null; // Firebase user object
        let currentUserProfile = null; // Custom user profile from Firestore
        let currentAppPage = 'loading'; // 'loading', 'auth', 'registerProfile', 'farmerDashboard'
        let currentDashboardTab = 'getRecommendations'; // 'getRecommendations', 'recommendationHistory'

        // Firebase Configuration - REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL FIREBASE CONFIG
        // From Firebase Console -> Project settings -> Your apps -> Web app -> Firebase SDK snippet -> Config
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC-NpqjjsBz9kZhmztF9JghVSrzUp5dNzo",
  authDomain: "agrosense-ai-5e7ec.firebaseapp.com",
  projectId: "agrosense-ai-5e7ec",
  storageBucket: "agrosense-ai-5e7ec.firebasestorage.app",
  messagingSenderId: "1003077383390",
  appId: "1:1003077383390:web:655366d833cd49bfd3be4f",
  measurementId: "G-Q7ZDDFGHHF"
};
        // This `appId` is used within your Firestore collection paths. It should ideally be your Firebase project ID for consistency
        // or a unique string for your app's data segregation.
        const appId = firebaseConfig.projectId || 'agrosense-ai-app-local'; // Fallback for local dev if projectId is not set initially


        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingMessage = document.getElementById('loading-message');
        const loadingErrorDetail = document.getElementById('loading-error-detail');

        const authPage = document.getElementById('auth-page');
        const profileSetupPage = document.getElementById('profile-setup-page');
        const farmerDashboard = document.getElementById('farmer-dashboard');

        // Auth Page Elements
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authErrorMessage = document.getElementById('auth-error-message');
        const authSuccessMessage = document.getElementById('auth-success-message');

        // Profile Setup Page Elements
        const profileForm = document.getElementById('profile-form');
        const profileNameInput = document.getElementById('profile-name');
        const farmLocationInput = document.getElementById('farm-location');
        const profileErrorMessage = document.getElementById('profile-error-message');
        const profileSuccessMessage = document.getElementById('profile-success-message');

        // Header Elements
        const welcomeMessageSpan = document.getElementById('welcome-message');
        const userIdDisplaySpan = document.getElementById('user-id-display');
        const logoutButton = document.getElementById('logout-button');

        // Dashboard Elements
        const dashboardUserIdSpan = document.getElementById('dashboard-user-id');
        const tabGetRecommendationsButton = document.getElementById('tab-get-recommendations');
        const tabRecommendationHistoryButton = document.getElementById('tab-recommendation-history');
        const tabContentGetRecommendations = document.getElementById('tab-content-get-recommendations');
        const tabContentRecommendationHistory = document.getElementById('tab-content-recommendation-history');

        // Get New Recommendations Tab Elements
        const cropTypeSelect = document.getElementById('crop-type');
        const soilMoistureSelect = document.getElementById('soil-moisture');
        const temperatureInput = document.getElementById('temperature');
        const humidityInput = document.getElementById('humidity');
        const weatherForecastSelect = document.getElementById('weather-forecast');
        const pestDiseaseSelect = document.getElementById('pest-disease');
        const generateRecommendationsButton = document.getElementById('generate-recommendations-button');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiErrorDisplay = document.getElementById('ai-error-display');
        const aiResponseDisplay = document.getElementById('ai-response-display');
        const aiPlaceholderMessage = document.getElementById('ai-placeholder-message');

        // Recommendation History Tab Elements
        const recommendationHistoryList = document.getElementById('recommendation-history-list');

        // Custom Alert Modal Elements
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertCloseButton = document.getElementById('custom-alert-close');

        // --- Utility Functions ---

        /**
         * Displays a custom alert modal.
         * @param {string} message The message to display in the alert.
         */
        function showAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        /**
         * Hides all main content sections.
         */
        function hideAllSections() {
            loadingScreen.classList.add('hidden');
            authPage.classList.add('hidden');
            profileSetupPage.classList.add('hidden');
            farmerDashboard.classList.add('hidden');
        }

        /**
         * Navigates to a specific page/section of the application.
         * @param {string} page 'auth', 'registerProfile', 'farmerDashboard'
         */
        function navigateToPage(page) {
            hideAllSections(); // Hide all first
            currentAppPage = page; // Update global state
            switch (page) {
                case 'auth':
                    authPage.classList.remove('hidden');
                    break;
                case 'registerProfile':
                    profileSetupPage.classList.remove('hidden');
                    break;
                case 'farmerDashboard':
                    farmerDashboard.classList.remove('hidden');
                    updateDashboardUI(); // Update dashboard content
                    break;
                default:
                    console.error('Unknown page:', page);
                    break;
            }
        }

        /**
         * Updates the header UI based on current user and profile.
         */
        function updateHeaderUI() {
            if (currentUserProfile) {
                welcomeMessageSpan.textContent = `Welcome, ${currentUserProfile.name} (${currentUserProfile.farmLocation})`;
                welcomeMessageSpan.classList.remove('hidden');
                userIdDisplaySpan.textContent = `ID: ${currentUser?.uid.substring(0, 8)}...`;
                userIdDisplaySpan.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
            } else {
                welcomeMessageSpan.textContent = '';
                welcomeMessageSpan.classList.add('hidden');
                userIdDisplaySpan.textContent = '';
                userIdDisplaySpan.classList.add('hidden');
                logoutButton.classList.add('hidden');
            }
        }

        /**
         * Updates the dashboard content based on the active tab.
         */
        function updateDashboardUI() {
            // Update tab styles
            tabGetRecommendationsButton.classList.remove('text-emerald-600', 'border-b-2', 'border-emerald-600', 'text-gray-600', 'hover:text-gray-800');
            tabRecommendationHistoryButton.classList.remove('text-emerald-600', 'border-b-2', 'border-emerald-600', 'text-gray-600', 'hover:text-gray-800');

            if (currentDashboardTab === 'getRecommendations') {
                tabGetRecommendationsButton.classList.add('text-emerald-600', 'border-b-2', 'border-emerald-600');
                tabRecommendationHistoryButton.classList.add('text-gray-600', 'hover:text-gray-800');
                tabContentGetRecommendations.classList.remove('hidden');
                tabContentRecommendationHistory.classList.add('hidden');
            } else {
                tabRecommendationHistoryButton.classList.add('text-emerald-600', 'border-b-2', 'border-emerald-600');
                tabGetRecommendationsButton.classList.add('text-gray-600', 'hover:text-gray-800');
                tabContentRecommendationHistory.classList.remove('hidden');
                tabContentGetRecommendations.classList.add('hidden');
            }
            dashboardUserIdSpan.textContent = currentUser?.uid || 'N/A';
        }

        // --- Firebase Initialization and Auth Logic ---

        /**
         * Initializes Firebase app, gets auth/firestore instances, and attempts initial auth.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // Check for essential Firebase config parameters immediately
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId || !firebaseConfig.authDomain) {
                    loadingSpinner.classList.add('hidden');
                    loadingMessage.textContent = "Initialization failed: Firebase configuration missing or incomplete.";
                    loadingErrorDetail.classList.remove('hidden');
                    loadingErrorDetail.innerHTML = `
                        <p>Please update the <code>firebaseConfig</code> object in the script section of this HTML file.</p>
                        <p>Go to your Firebase Console -> Project settings -> Your apps -> Web app -> Firebase SDK snippet (Config) to get your values.</p>
                        <p>Ensure <code>apiKey</code>, <code>projectId</code>, and <code>authDomain</code> are correctly set.</p>
                    `;
                    // Prevent further execution if config is bad
                    throw new Error("Firebase configuration missing or incorrect, stopping initialization.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up auth state listener AFTER firebase app and auth instances are initialized
                onAuthStateChanged(auth, handleAuthStateChanged);

                // Attempt initial authentication (anonymous or with custom token)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Signed in with custom token.');
                } else {
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously.');
                }
            } catch (error) {
                console.error('Firebase initialization or initial authentication error:', error);
                loadingSpinner.classList.add('hidden'); // Hide spinner on error
                loadingMessage.textContent = "Initialization failed: " + error.message;
                loadingErrorDetail.classList.remove('hidden');
                loadingErrorDetail.textContent = 'Please ensure Firebase Authentication methods (Anonymous, Email/Password) are enabled in your Firebase Console (Authentication > Sign-in method).';
            }
        }

        /**
         * Handles user state changes from Firebase Auth.
         * @param {Object} user Firebase User object or null.
         */
        async function handleAuthStateChanged(user) {
            currentUser = user;
            if (currentUser && db) {
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profiles`, currentUser.uid);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists()) {
                    currentUserProfile = userProfileSnap.data();
                    navigateToPage('farmerDashboard');
                } else {
                    currentUserProfile = null;
                    navigateToPage('registerProfile');
                }
            } else {
                currentUserProfile = null;
                navigateToPage('auth');
            }
            updateHeaderUI(); // Always update header based on latest state
        }

        /**
         * Handles Login/Sign Up form submission.
         * @param {Event} e Form submission event.
         */
        async function handleAuthFormSubmit(e) {
            e.preventDefault();
            authErrorMessage.classList.add('hidden');
            authSuccessMessage.classList.add('hidden');
            authErrorMessage.textContent = '';
            authSuccessMessage.textContent = '';

            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const isLoginMode = authSubmitButton.textContent === 'Login';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                    authSuccessMessage.textContent = 'Logged in successfully!';
                    authSuccessMessage.classList.remove('hidden');
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    authSuccessMessage.textContent = 'Account created successfully! Please set up your farm profile.';
                    authSuccessMessage.classList.remove('hidden');
                    // onAuthStateChanged will handle navigation to registerProfile
                }
            } catch (err) {
                console.error('Authentication error:', err);
                authErrorMessage.textContent = err.message;
                authErrorMessage.classList.remove('hidden');
            }
        }

        /**
         * Toggles between Login and Sign Up modes on the auth page.
         */
        function toggleAuthMode() {
            const isLoginMode = authSubmitButton.textContent === 'Login';
            if (isLoginMode) {
                authTitle.textContent = 'Sign Up for AgroSense AI';
                authSubmitButton.textContent = 'Sign Up';
                toggleAuthModeButton.textContent = 'Login';
            } else {
                authTitle.textContent = 'Login to AgroSense AI';
                authSubmitButton.textContent = 'Login';
                toggleAuthModeButton.textContent = 'Sign Up';
            }
            authErrorMessage.classList.add('hidden'); // Clear errors on toggle
            authSuccessMessage.classList.add('hidden'); // Clear messages on toggle
        }

        /**
         * Handles profile setup form submission.
         * @param {Event} e Form submission event.
         */
        async function handleProfileFormSubmit(e) {
            e.preventDefault();
            profileErrorMessage.classList.add('hidden');
            profileSuccessMessage.classList.add('hidden');
            profileErrorMessage.textContent = '';
            profileSuccessMessage.textContent = '';

            if (!currentUser) {
                profileErrorMessage.textContent = "User not authenticated. Please log in again.";
                profileErrorMessage.classList.remove('hidden');
                return;
            }

            try {
                const profileData = {
                    email: currentUser.email,
                    name: profileNameInput.value,
                    farmLocation: farmLocationInput.value,
                    uid: currentUser.uid,
                    createdAt: serverTimestamp(),
                };
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profiles`, currentUser.uid);
                await setDoc(userProfileRef, profileData);
                currentUserProfile = profileData; // Update global profile
                profileSuccessMessage.textContent = 'Farm profile created successfully!';
                profileSuccessMessage.classList.remove('hidden');
                navigateToPage('farmerDashboard');
            } catch (err) {
                console.error('Error creating profile:', err);
                profileErrorMessage.textContent = 'Failed to create profile: ' + err.message;
                profileErrorMessage.classList.remove('hidden');
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log('User logged out.');
                // onAuthStateChanged will handle clearing currentUser/Profile and navigating to auth page
            } catch (error) {
                console.error('Error logging out:', error);
                showAlert('Failed to log out. Please try again.');
            }
        }

        // --- Dashboard Logic ---

        /**
         * Fetches and displays past recommendations for the current user.
         */
        function fetchAndDisplayRecommendations() {
            if (!db || !currentUser) {
                recommendationHistoryList.innerHTML = '<p class="text-gray-600 text-center py-8">Please log in to view your history.</p>';
                return;
            }
            recommendationHistoryList.innerHTML = '<p class="text-gray-600 text-center py-8">Loading past recommendations...</p>';

            const q = query(
                collection(db, `artifacts/${appId}/users/${currentUser.uid}/recommendations`),
                orderBy('timestamp', 'desc')
            );

            // Set up real-time listener for recommendations
            onSnapshot(q, (snapshot) => {
                const fetchedRecs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (fetchedRecs.length === 0) {
                    recommendationHistoryList.innerHTML = '<p class="text-gray-600 text-center py-8">No past recommendations found. Generate some!</p>';
                    return;
                }

                recommendationHistoryList.innerHTML = ''; // Clear existing list
                fetchedRecs.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                    recDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-lg font-semibold text-gray-800">
                                Recommendation for ${rec.cropType} -
                                ${rec.timestamp ? new Date(rec.timestamp.toDate()).toLocaleDateString() : 'N/A'}
                            </h4>
                            <button class="delete-rec-button text-red-500 hover:text-red-700 transition-colors" title="Delete Recommendation" data-id="${rec.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <p class="text-gray-700 text-sm mb-2">
                            <strong>Conditions:</strong> Soil: ${rec.soilMoisture}, Temp: ${rec.temperature}Â°C, Hum: ${rec.humidity}%, Weather: ${rec.weatherForecast}, Pests: ${rec.pestDisease}
                        </p>
                        <div class="bg-white p-3 rounded border border-gray-100 text-sm whitespace-pre-wrap">
                            ${rec.generatedRecommendation}
                        </div>
                    `;
                    recommendationHistoryList.appendChild(recDiv);
                });

                // Attach event listeners to delete buttons
                recommendationHistoryList.querySelectorAll('.delete-rec-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const recId = e.currentTarget.dataset.id;
                        if (confirm('Are you sure you want to delete this recommendation?')) { // Using confirm as this is a specific action, not a general alert.
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/recommendations`, recId));
                                showAlert('Recommendation deleted.');
                            } catch (deleteError) {
                                console.error('Error deleting recommendation:', deleteError);
                                showAlert('Failed to delete recommendation.');
                            }
                        }
                    });
                });
            }, (error) => {
                console.error("Error fetching recommendations:", error);
                recommendationHistoryList.innerHTML = `<p class="bg-red-100 text-red-700 p-3 rounded-md mb-4 text-sm">Error loading history: ${error.message}</p>`;
            });
        }


        /**
         * Calls the Gemini API to generate agricultural recommendations.
         */
        async function generateAgroSenseRecommendations() {
            aiLoadingSpinner.classList.remove('hidden');
            aiErrorDisplay.classList.add('hidden');
            aiResponseDisplay.classList.add('hidden');
            aiPlaceholderMessage.classList.add('hidden');
            generateRecommendationsButton.disabled = true;
            generateRecommendationsButton.textContent = 'Generating...';

            const cropType = cropTypeSelect.value;
            const soilMoisture = soilMoistureSelect.value;
            const temperature = temperatureInput.value;
            const humidity = humidityInput.value;
            const weatherForecast = weatherForecastSelect.value;
            const pestDisease = pestDiseaseSelect.value;

            const prompt = `Act as an AI agricultural expert for smallholder farmers. Based on the following farm conditions, provide actionable and ethical recommendations for optimizing agricultural practices. Explain the reasoning briefly.

            Farm Conditions:
            - Crop Type: ${cropType}
            - Soil Moisture: ${soilMoisture}
            - Temperature: ${temperature}Â°C
            - Humidity: ${humidity}%
            - Weather Forecast (next 7 days): ${weatherForecast}
            - Pest/Disease Presence: ${pestDisease}

            Provide recommendations covering:
            1. Precision Irrigation (e.g., how much water, when)
            2. Intelligent Fertilization (e.g., type, amount, timing)
            3. Early Warning for Pests/Diseases (e.g., potential risks, prevention)
            4. Optimal Planting/Harvesting Schedules (e.g., best timing)
            5. Climate-Resilient Crop Selection (e.g., suitability of current crop, alternative suggestions if current forecast is challenging)

            Ensure the recommendations are practical, easy to understand, and emphasize sustainable practices. Do not mention specific products or brands.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this in runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData?.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    aiResponseDisplay.textContent = text;
                    aiResponseDisplay.classList.remove('hidden');

                    // Save the generated recommendation to Firestore history
                    if (db && currentUser) {
                        await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/recommendations`), {
                            cropType, soilMoisture, temperature: parseFloat(temperature), humidity: parseFloat(humidity), weatherForecast, pestDisease,
                            generatedRecommendation: text,
                            timestamp: serverTimestamp(),
                        });
                    }

                } else {
                    aiErrorDisplay.textContent = 'Failed to get a valid response from AI. Please try again.';
                    aiErrorDisplay.classList.remove('hidden');
                    console.warn('Unexpected AI response structure:', result);
                }
            } catch (err) {
                console.error('Error calling Gemini API:', err);
                aiErrorDisplay.textContent = 'Error generating recommendations: ' + err.message;
                aiErrorDisplay.classList.remove('hidden');
            } finally {
                aiLoadingSpinner.classList.add('hidden');
                generateRecommendationsButton.disabled = false;
                generateRecommendationsButton.textContent = 'Generate Recommendations';
            }
        }


        // --- Event Listeners ---
        window.onload = async () => {
            await initializeFirebaseAndAuth();
        };

        authForm.addEventListener('submit', handleAuthFormSubmit);
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);
        profileForm.addEventListener('submit', handleProfileFormSubmit);
        logoutButton.addEventListener('click', handleLogout);

        tabGetRecommendationsButton.addEventListener('click', () => {
            currentDashboardTab = 'getRecommendations';
            updateDashboardUI();
        });

        tabRecommendationHistoryButton.addEventListener('click', () => {
            currentDashboardTab = 'recommendationHistory';
            updateDashboardUI();
            fetchAndDisplayRecommendations(); // Fetch history when tab is clicked
        });

        generateRecommendationsButton.addEventListener('click', generateAgroSenseRecommendations);

        customAlertCloseButton.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

    </script>
</body>
</html>
